{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Attendance" %}{% endblock %}

{% block content %}
<div class="container mt-4">

    <h5 class="text-center fw-bold text-primary">{% trans "Attendances" %}</h5>

    <!-- Filter Section -->
    <form action="{% url 'attendance' %}" method="GET">
        {% csrf_token %}
        <div class="row g-3 align-items-end">
            <div class="col-md-4">
                <label for="dateInput" class="form-label">{% trans "Select Date" %}</label>
                <input type="date" 
                       class="form-control" 
                       id="dateInput" 
                       name="selected_date"
                       max="{{ today|date:'Y-m-d' }}"
                       {% if selected_date %}
                         value="{{ selected_date }}"
                       {% else %}
                         value="{{ today|date:'Y-m-d' }}"
                       {% endif %}
                >
            </div>

            <div class="col-md-5">
                <label for="groupSelect" class="form-label">{% trans "Choose Group" %}</label>
                <select class="form-select" id="groupSelect" name="selected_group">
                    <option value="">{% trans "--------" %}</option>
                    {% for group in groups %}
                        <option value="{{ group.id }}" {% if group.id|stringformat:"s" == selected_group|stringformat:"s" %}selected{% endif %}>
                            {{ group }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3">
                <button id="filter-button" type="submit" class="btn btn-primary w-100">{% trans "Go" %}</button>
            </div>
        </div>
    </form>

    <br>

    <!-- Attendance Table -->
    <form action="{% url 'attendance' %}" method="POST">
        {% csrf_token %}
        <input type="hidden" name="selected_date" value="{{ selected_date }}">
        <input type="hidden" name="selected_group" value="{{ selected_group }}">

        <table class="table table-bordered table-striped text-start align-middle" id="attendanceTable">
            <thead class="table-light">
                <tr>
                    <th colspan="4" class="text-center">{% trans "Students" %}</th>
                </tr>
                <tr>
                    <th>{% trans "Code ID" %}</th>
                    <th>{% trans "Student Name" %}</th>
                    <th>{% trans "Status" %}</th>
                    <th>{% trans "Present" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for student in group_students %}
                    <input type="hidden" name="student_ids" value="{{ student.student_id }}">
                    <tr>
                        <td>{{ student.student_code }}</td>
                        <td>{{ student.student_name }}</td>
                        <td>
                            {% if student.status %}
                                <ul class="list-unstyled m-0 p-0">
                                    {% for status in student.status %}
                                        <li class="d-inline-block me-1 mb-1">
                                            <span class="badge bg-danger" style="font-size: 0.8rem; padding: 0.5em 0.7em;">{{ status }}</span>
                                        </li>
                                    {% endfor %}
                                </ul>
                            {% else %}
                                <span class="text-success">&#10004;</span>
                            {% endif %}
                        </td>
                        <td>
                            <input type="checkbox" class="form-check-input" name="present_{{ student.student_id }}"
                            {% if student.present %}checked{% endif %}/>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="row justify-content-center">
            <div class="col-md-3 d-flex justify-content-center">
                <button id="save-button" type="submit" class="btn btn-success w-100">{% trans "Save" %}</button>
            </div>
        </div>
    </form>
</div>

<script>
    $(document).ready(function () {
        const saveButton = $('#save-button');
        const tableBody = $('#attendanceTable tbody');

        // Disable save if no data
        saveButton.prop('disabled', tableBody.find('tr').length === 0);

        function checkButtonState() {
            const dateValue = $('#dateInput').val();
            const groupValue = $('#groupSelect').val();
            $('#filter-button').prop('disabled', !(dateValue && groupValue));
        }

        $('#dateInput, #groupSelect').on('change', checkButtonState);
        checkButtonState();
    });
</script>
{% endblock %}
